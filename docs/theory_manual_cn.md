# mini_fem_solver 理论教材（从零到可实现）

> 本文不是“目录式提纲”，而是按教材方式展开：背景知识 → 基础数学 → 连续介质力学 → 有限元离散 → 非线性算法 → 接触/约束 → 数值稳定性 → 工程验证。

---

## 第 0 章：如何使用本教材

### 0.1 目标读者
- 完全不了解有限元（FEM）的读者。
- 会用 Abaqus/Ansys 但不理解内部算法的工程师。
- 想把算法落地到代码的开发者。

### 0.2 学习建议
1. 先读第 1~6 章建立直觉。
2. 再读第 7~12 章掌握算法核心。
3. 最后读第 13~18 章（稳定性、验证、工程化）。
4. 每章后都用 `examples/` 里的最小算例实践。

### 0.3 记号说明
- \(\mathbf{u}\)：位移自由度向量。
- \(\mathbf{R}\)：残量（外力减内力）。
- \(\mathbf{K}_t\)：切线刚度矩阵。
- \(\lambda\)：载荷比例因子。

---

## 第 1 章：为什么要学有限元

### 1.1 结构分析到底在求什么
一个结构静力问题，本质是“已知输入，求平衡状态”：
- 输入：几何、材料、边界约束、外载荷。
- 输出：位移、应变、应力、反力、是否屈服或失稳。

### 1.2 为什么解析法不够
解析法（手算）依赖规则几何和理想边界。
真实工程构件：
- 形状复杂；
- 受力路径复杂；
- 材料可能非线性；
- 可能发生接触与摩擦。

因此必须采用数值离散方法。

### 1.3 有限元的核心思想
- 把连续体拆成很多小单元。
- 在每个小单元里用低阶函数近似位移场。
- 通过变分/加权残值把 PDE 转成代数方程组。
- 通过线性代数与迭代方法求解。

---

## 第 2 章：必须掌握的数学基础

### 2.1 向量、矩阵、张量
在程序实现里，几乎一切都可视为矩阵运算：
- 位移：向量。
- 应变/应力：张量（通常 Voigt 化为 6 分量）。
- 刚度：矩阵。

### 2.2 线性化与牛顿思想
非线性方程 \(R(u)=0\) 无法直接解时，线性化：
\[
R(u+\Delta u) \approx R(u) + \frac{\partial R}{\partial u}\Delta u
\]
得到每步线性系统：
\[
K_t \Delta u = -R
\]

### 2.3 范数与收敛判据
常用判据：
- 残量范数 \(\|R\|\) 足够小；
- 位移增量范数 \(\|\Delta u\|\) 足够小。

两者结合比单一判据更稳健。

---

## 第 3 章：连续介质力学入门

### 3.1 位移、应变、应力
- 位移：点的几何移动。
- 应变：相对变形程度。
- 应力：单位面积内力。

### 3.2 小变形理论
本项目多数模型采用小变形框架，意味着：
- 几何非线性影响可选/弱化；
- 应变定义简化；
- 数值实现更稳定、易调试。

### 3.3 平衡方程与边界条件
连续体中有：
- 体内平衡方程；
- 位移边界（Dirichlet）；
- 力边界（Neumann）。

有限元要做的是将其离散到节点自由度层面。

### 3.4 虚功原理
虚功形式是有限元离散统一入口：
\[
\delta W_{int}-\delta W_{ext}=0
\]

---

## 第 4 章：从连续到离散（有限元基本流程）

### 4.1 网格划分
将结构离散为节点 + 单元。

### 4.2 形函数插值
单元内部位移近似：
\[
u(x) \approx N(x) d
\]
其中 \(d\) 是节点自由度。

### 4.3 B 矩阵
应变与节点自由度关系：
\[
\varepsilon = B d
\]

### 4.4 单元刚度
\[
K_e = \int_{\Omega_e} B^T D B \, d\Omega
\]

### 4.5 单元内力
\[
f_{int,e}=\int_{\Omega_e} B^T \sigma \, d\Omega
\]

### 4.6 全局组装
用 DOF map 把每个单元贡献累计到全局 \(K\)、\(f_{int}\)。

### 4.7 施加边界
对固定自由度执行行列修改/约束处理。

### 4.8 求解与后处理
解出 \(u\) 后，恢复应力/应变/反力并输出 VTK。

---

## 第 5 章：本项目单元家族与物理意义

### 5.1 Truss2
- 仅轴向拉压。
- 适合最小验证模型。

### 5.2 Beam31/Beam33
- 考虑弯曲、轴向、扭转。
- 适合细长构件。

### 5.3 Shell4/S4R
- 面内 + 弯曲行为。
- 适合薄壁结构。

### 5.4 C3D8/C3D8R
- 三维实体通用模型。
- C3D8R 需关注 hourglass 风险。

---

## 第 6 章：材料模型教材化讲解

### 6.1 线弹性
\[
\sigma = D\varepsilon
\]

### 6.2 双线性弹塑性
- 先弹性；
- 达屈服后按硬化模量继续增长。

### 6.3 J2 塑性
核心是“弹性试算 + 屈服判断 + 回归映射”。

### 6.4 Return-Mapping 的工程解释
回归映射可以理解为：
- 先假设完全弹性，算到“试应力点”；
- 如果超出屈服面，就沿法向“拉回屈服面”；
- 更新塑性内变量并输出新应力。

---

## 第 7 章：非线性求解主线（Newton-Raphson）

### 7.1 残量定义
\[
R(u,\lambda)=f_{ext}(\lambda)-f_{int}(u)
\]

### 7.2 每步迭代
1. 组装 \(K_t\)、\(f_{int}\)。
2. 计算残量 \(R\)。
3. 解 \(K_t\Delta u=R\)。
4. 更新 \(u\leftarrow u+\Delta u\)。
5. 检查收敛。

### 7.3 cutback
当当前步不收敛时，减小步长重算，提升稳健性。

---

## 第 8 章：接触与摩擦（本项目实现 + 理论背景）

### 8.1 接触约束本质
不允许穿透：法向间隙 \(g_n\ge 0\)。

### 8.2 罚函数法
若穿透（\(g_n<0\)）则施加恢复力：
\[
p_n = k_n g_n
\]

### 8.3 摩擦（库仑）
\[
\|t\|\le \mu p_n
\]
- 未超限：粘着；
- 超限：滑移并投影到摩擦圆锥边界。

### 8.4 当前工程近似
本项目目前采用 node-to-node 配对，优点是实现简洁、可维护，后续可升级 node-to-surface / surface-to-surface。

---

## 第 9 章：约束方程（Coupling / MPC / Lagrange）

### 9.1 统一线性约束形式
\[
\sum_i c_i u_i = g
\]

### 9.2 增广方程
\[
\begin{bmatrix}
K & C^T \\
C & 0
\end{bmatrix}
\begin{bmatrix}
\Delta u \\
\Delta \lambda_c
\end{bmatrix}
=
-\begin{bmatrix}
R \\
g
\end{bmatrix}
\]

### 9.3 工程优劣
- 优点：表达直接、扩展方便；
- 代价：系统规模增大，可能影响线性求解效率。

---

## 第 10 章：弧长法与极限点问题

### 10.1 常规载荷控制的问题
遇到极限点后，载荷-位移曲线斜率变化可能导致常规增量法失效。

### 10.2 弧长思想
约束“增量长度”而不是仅约束载荷增量，使解沿平衡路径前进。

### 10.3 本项目参数化弧长框架
- `arcLengthRadius`
- `arcLengthGrowFactor`
- `arcLengthShrinkFactor`
- `arcLengthMinRadius`/`MaxRadius`

---

## 第 11 章：数值积分、锁死和 hourglass

### 11.1 高斯积分
通过有限积分点近似体积分。

### 11.2 全积分 vs 减缩积分
- 全积分稳定但可能锁死；
- 减缩积分效率高但可能 hourglass。

### 11.3 锁死现象
- 剪切锁死；
- 体积锁死。

### 11.4 hourglass
零能模态导致畸形变形，需要稳定项抑制。

---

## 第 12 章：线性求解器与计算复杂度

### 12.1 Dense
实现简单，规模上去后复杂度高。

### 12.2 Eigen 稀疏
适合稀疏系统，内存与时间更优。

### 12.3 PETSc
适合更大规模与并行扩展。

### 12.4 PCG
适用于近 SPD 系统，配合 OpenMP 可加速。

---

## 第 13 章：误差、收敛与可信度

### 13.1 三重概念
- 一致性：离散形式是否正确逼近连续问题。
- 稳定性：扰动是否可控。
- 收敛性：网格细化是否趋近真实解。

### 13.2 网格收敛测试
逐步加密网格，观察关键指标是否稳定。

### 13.3 参数敏感性
接触罚系数、增量步长、收敛阈值都会影响结果与稳定性。

---

## 第 14 章：如何读懂输入文件（教学案例）

### 14.1 输入顺序
`*Node -> *Element -> *Material -> *Section -> *Boundary -> *Load -> *Step`

### 14.2 最小运行
```bash
./build/fem_solver examples/classic_bar_tension.inp output/classic_bar.vtk 1.0 dense
```

### 14.3 仅检查输入
```bash
./build/fem_solver --check-inp examples/advanced_keywords.inp
```

---

## 第 15 章：给零基础读者的背景补课

### 15.1 应力与应变直觉
- 应力：材料内部“被拉扯/压缩的程度”。
- 应变：变形比例。

### 15.2 杨氏模量与泊松比
- 杨氏模量越大，材料越“硬”。
- 泊松比反映横向收缩效应。

### 15.3 屈服与塑性
超过屈服后，卸载可能无法回到原状。

### 15.4 为什么要做验证
数值结果“看起来合理”不等于“真实可靠”。

---

## 第 16 章：术语表（中英对照）

- Residual：残量
- Tangent stiffness：切线刚度
- Return mapping：返回映射
- Cutback：减步回退
- Arc-length：弧长法
- Penalty method：罚函数法
- Lagrange multiplier：拉格朗日乘子
- Convergence：收敛
- Conditioning：条件性/病态程度

---

## 第 17 章：与 Abaqus 对标视角

### 17.1 目前已具备
- 多单元基础框架；
- 非线性迭代；
- 接触与约束骨架；
- 跨平台部署与回归案例。

### 17.2 持续增强方向
- 更标准 surface-to-surface 接触；
- 更严格一致切线；
- 更完整 Riks 联立弧长实现；
- 稀疏矩阵数据结构重构。

---

## 第 18 章：实践作业（建议按章节完成）

1. 跑通 3 个经典案例并解释位移数量级。
2. 修改一个材料参数，观察结果变化并说明原因。
3. 修改 `*Controls`，比较迭代步数与收敛稳定性。
4. 在 advanced 案例中调接触罚系数，分析收敛趋势。
5. 写一页报告：你理解的“数值稳定不等于物理正确”。

---

## 附录 A：常用方程速查

\[
R = f_{ext} - f_{int}
\]
\[
K_t\Delta u = R
\]
\[
\begin{bmatrix}K&C^T\\C&0\end{bmatrix}\begin{bmatrix}\Delta u\\\Delta\lambda\end{bmatrix}=-\begin{bmatrix}R\\g\end{bmatrix}
\]
\[
\|t\|\le \mu p_n
\]

---

## 附录 B：30 天学习路线

- Day 1~5：力学与数学基础。
- Day 6~10：离散化与单元。
- Day 11~15：材料与非线性。
- Day 16~20：接触与约束。
- Day 21~25：求解器与稳定性。
- Day 26~30：案例复现 + 小改动 + 文档总结。

